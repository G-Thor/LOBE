{% extends "__base.jinja" %}
{% block headscripts %}
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
{% endblock %}
{% block body %}
    <div class='row mb-3 mt-md-0 mt-n4'>
        <div class='col-12'>
            <h3 class='font-weight-bold'>Greining</h3>
            <h4 class='font-weight-bold'>Lota: {{session.get_printable_id()}}</h4>
        </div>
        <div class='col-12'>
            <div class="progress">
                <div class="progress-bar bg-success" id='progressBar' role="progressbar"></div>
            </div>
        </div>
    </div>
    <div class='row'>
        <div class='col-12 controls mb-3 d-flex justify-content-{% if single %}around{% else%}between{% endif %}'>
            <button id='prev' class='btn btn-sm btn-secondary rounded-pill' type='button'>
                <i class='fa fa-arrow-left mr-1 ml-1'></i>
                <span class='font-weight-bold mr-1'>Fyrri</span>
            </button>
            <button id='next' class='btn btn-sm btn-secondary rounded-pill' type='button'>
                <span class='font-weight-bold ml-1 mr-1'>Næsti</span>
                <i class='fa fa-arrow-right mr-1'></i>
            </button>
        </div>
    </div>

    <div class='row'>
        <div class='col-xl-6 col-md-8 offset-xl-3 offset-md-2 col-12 mb-2'>
            <div id='tokenCard' class="card">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h3 class='card-text' id='tokenText'></h3>
                    <p class='card-text mb-0'>
                        <span class='float-right rounded-pill bg-secondary text-success px-2 py-1'><span id='currentIndexSpan'></span>/<span id='totalIndexSpan'></span></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class='row'>
        <div class='col-xl-6 col-md-8 offset-xl-3 offset-md-2 col-12 mb-2'>
            <div id='recordingCard' class='card'>
                <div class='card-body'>
                    <div id="waveform"></div>
                </div>
                <ul class='list-group list-group-flush'>
                    <li class='list-group-item'>
                        <div class='btn-group float-right' role='group'>
                            <button id='cut' type='button' class='btn btn-secondary btn-sm'>
                                <span id='cutButtonText'>Klippa</span>
                                <i id='cutButtonIcon' class='fa fa-cut text-success ml-1'></i>
                            </button>
                            <button id='play' type='button' class='btn btn-secondary btn-sm'>
                                <i id='playButtonIcon' class='fa fa-play'></i>
                            </button>
                            <button id='download' class="btn btn-secondary btn-sm"><i class='fa fa-download'></i></button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <form id="verificationForm" action="verification/" method="POST">
        {{ form.recording }}
        <div class="row mt-3">
            <div class="col-xl-6 col-md-8 offset-xl-3 offset-md-2 col-12 mb-2">
                {{ form.quality }}
            </div>
        </div>
        <div class="row mt-1">
            <div class="col-xl-6 col-md-8 offset-xl-3 offset-md-2 col-12 mb-2">
                <div class="form-group">
                    <label>Athugasemd</label>
                    {{ form.comment(class="form-control", rows=2) }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-6 col-md-8 offset-xl-3 offset-md-2 col-12 mb-2">
                <button id="verify" class="btn btn-primary float-right">Senda</button>
            </div>
        </div>
    </form>

{% endblock %}
{% block modals %}
    <div class="modal fade" id='errorModal' tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Villa!</h5>
                    <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class='font-weight-bold' id='errorTitleElement'></p>
                    <p><code class='font-weight-bold' id='errorMsgElement'></code></p>
                    <p><code id='errorStackElement'></code></p>
                    <p>Hafið samband við vefstjóra eða reynið aftur.</p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Loka</button>
                    <a href="{{request.path}}" class='btn btn-primary'>
                        Reyna aftur
                        {{macros.btn_icon('redo', 'l')}}
                    </a>
                </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{super()}}
    <script src='{{url_for("static", filename="js/error.js")}}'></script>
    <script src='{{url_for("static", filename="js/surf.js")}}'></script>
    <script>
        let wavesurfer;

        var session = {{json_session}};
        var recordings = session.recordings;
        var recIndex = 0;
        var numRecordings = recordings.length

        const tokenText = document.querySelector("#tokenText");
        const tokenIDSpan = document.querySelector("#tokenID");
        const tokenHref= document.querySelector("#tokenHref");
        const tokenfileIDSpan = document.querySelector("#tokenFileID");
        const progressBar = document.querySelector('#progressBar');
        const currentIndexSpan = document.querySelector('#currentIndexSpan');
        document.querySelector('#totalIndexSpan').innerHTML = numRecordings;

        //buttons
        const nextButton = document.querySelector('button#next');
        const prevButton = document.querySelector('button#prev');
        const playButton = document.querySelector('button#play');
        const playButtonIcon = document.querySelector('#playButtonIcon');

        nextButton.addEventListener('click', nextAction);
        prevButton.addEventListener('click', prevAction);
        playButton.addEventListener('click', playAction);

        let disableShortcuts = false;
        let disableEnterAction = false;

        const qualitySelectors = document.querySelectorAll("#quality input");
        const commentField = document.querySelector("textarea#comment");
        commentField.addEventListener('focus', function() { disableShortcuts = true; });
        commentField.addEventListener('blur', function() { disableShortcuts = false; });
        const sendVerificationButton = document.querySelector("button#verify")
        sendVerificationButton.addEventListener('focus', function() { disableEnterAction = true; });
        sendVerificationButton.addEventListener('blur', function() { disableEnterAction = false; });
        sendVerificationButton.addEventListener('click', function(e) {
            e.preventDefault();
            postForm();
        });

        $(window).keyup(function (e) {
            if (disableShortcuts) return; // For example while inside text field

            if(e.keyCode === 37 || e.keyCode === 65){ // arrow-left or "a"
                prevAction();
            } else if(e.keyCode === 39 || e.keyCode === 68){ // arrow-right or "d"
                nextAction();
            } else if(e.keyCode === 83){ // "s"
                playAction();
            } else if(e.keyCode === 66){ // "b"
                formAction("low");
            } else if(e.keyCode === 72){ // "h"
                formAction("high");
            } else if(e.keyCode === 74){ // "j"
                formAction("wrong");
            } else if(e.keyCode === 75){ // "k"
                formAction("glitch");
            } else if(e.keyCode === 76){ // "l"
                formAction("ok");
            } else if(e.keyCode === 13 && !disableEnterAction) { // enter
                postForm();
            }
        });

        function nextAction(){
            // Increment the sentence index and update the UI
            if(recIndex < numRecordings - 1){
                if(wavesurfer){wavesurfer.destroy()};
                recIndex += 1; updateUI();}
        }

        function prevAction(){
            // Decrement the sentence index and update the UI
            if(recIndex > 0){
                if(wavesurfer){wavesurfer.destroy()};
                recIndex -= 1; updateUI();
            }
        }

        function formAction(value) {
            // Check/uncheck form fields
            if (value == "ok") {
                // If 'ok' deselect others
                document.querySelectorAll("#quality input:not([value=ok])").forEach(
                    function(input){ input.checked = false; }
                );
            } else {
                // Make sure 'ok' is not selected
                document.querySelector("#quality input[value=ok]").checked = false;
            }
            let field = document.querySelector("#quality input[value=" + value + "]");
            field.checked = !field.checked;
        }

        function cleanForm() {
            commentField.value = "";
            qualitySelectors.forEach(function(input){ input.checked = false; });
            document.querySelector("input[name=recording]").value = "";
        }

        function postForm() {
            var xhr = new XMLHttpRequest();
            xhr.onload = function(e) {
                if(this.readyState === XMLHttpRequest.DONE) {
                    if(xhr.status == '200'){
                        // if we finish we go straight to the next recording
                        nextAction();
                    } else{
                        promptError("Villa koma upp:", xhr.responseText, "");
                    }
                }
            };

            let form = document.querySelector("#verificationForm");
            form.querySelector("input[name=recording]").value = session.recordings[recIndex].rec_id;
            let formData = new FormData(form);
            xhr.open("POST", form.action, true);
            xhr.send(formData);

        }

        async function playAction(){
            // Play the recording for the sentence at the current index.

            if(arePlaying()){
                wavesurfer.pause();
            } else{
                if(Object.keys(wavesurfer.regions.list).length > 0){
                    console.log('play selectio')
                    playSelections();
                } else{
                    wavesurfer.play();
                }
            }
        }

        playSelections = () => {
            const playlist = Object.values(wavesurfer.regions.list)
            playlist.sort((a, b) => (a.start > b.start ? 1 : -1))
            let curr = playlist.shift()
            console.log(playlist);
            wavesurfer.on('audioprocess', time => {
                if (time > curr.end && playlist.length > 0) {
                    curr = playlist.shift()
                    curr.play()
                } else if (time > curr.end && playlist.length === 0) {
                    wavesurfer.stop()
                }
            })

            wavesurfer.play(curr.start)
        }


        function updateTokenUI(){
            tokenText.innerHTML = recordings[recIndex]['text'];
        }

        function updateProgressUI(){
            var ratio = (recIndex + 1) / numRecordings * 100;
            progressBar.style.width = `${ratio.toString()}%`;
            currentIndexSpan.innerHTML = recIndex + 1;
        }

        function updateRecordingUI(){
            if(typeof wavesurfer === 'object'){
                wavesurfer.destroy();
            }
            wavesurfer = createRecordWaveSurfer('#waveform', false, playButtonIcon);
            wavesurfer.load(recordings[recIndex].rec_url);

            if(typeof recordings[recIndex].rec_trim.start === 'number' && typeof recordings[recIndex].rec_trim.end == 'number'){
                wavesurfer.addRegion({...recordings[recIndex].rec_trim,...{color: "rgba(243, 156, 18, 0.1)"}});
            }
        }

        function updateUI(){
            updateTokenUI();
            updateProgressUI();
            updateRecordingUI();
            cleanForm();
        }

        updateUI();

        function arePlaying(){
            if(wavesurfer){
                return wavesurfer.isPlaying();
            }
            return false;
        }

    </script>
{% endblock %}